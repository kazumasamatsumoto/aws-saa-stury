# AWS Key Management Service (KMS)

AWS KMS は、データの暗号化に使用する暗号化キーの作成と管理を容易にするマネージドサービスです。

クラウドサービスと暗号化まとめ

![クラウドサービスと暗号化まとめ](/image/security-identity&compliance/encryption/cloud-encryption-points.svg)

## 主な機能

1. **キーの作成と管理**

   - カスタマーマスターキー（CMK）の作成
   - キーのローテーション
   - キーのアクセス制御

2. **暗号化オペレーション**

   - データの暗号化・復号
   - エンベロープ暗号化
   - デジタル署名の生成と検証

3. **統合サービス**
   - S3、RDS、EBS などの AWS サービスとの統合
   - CloudTrail による監査ログ

## 暗号化のタイプ

### 1. 保存時の暗号化（Data at Rest）

- データベースの暗号化
- S3 バケットの暗号化
- EBS ボリュームの暗号化

### 2. 転送時の暗号化（Data in Transit）

- TLS/SSL 通信
- VPN 接続

## ベストプラクティス

1. **キー管理**

   - 定期的なキーローテーション
   - 最小権限の原則に基づくアクセス制御
   - バックアップと災害復旧計画の策定

2. **監視とログ記録**

   - CloudTrail による API 活動の監視
   - CloudWatch によるメトリクスの監視
   - アラートの設定

3. **コンプライアンス**
   - 規制要件への準拠
   - 定期的な監査
   - ドキュメント管理

## KMS で利用可能な暗号化方式

1. **対称暗号化**

   - AES-256-GCM
   - データキーの生成と管理
   - エンベロープ暗号化での利用

2. **非対称暗号化**

   - RSA-2048, 3072, 4096
   - ECC（楕円曲線暗号）
     - NIST 推奨曲線: P-256, P-384, P-521
     - デジタル署名での利用
     - 公開鍵暗号での利用

3. **HMAC（ハッシュベースのメッセージ認証コード）**

   - SHA-224, SHA-256, SHA-384, SHA-512
   - メッセージの完全性検証
   - API リクエストの認証

4. **暗号化アルゴリズムの用途**

   - データの暗号化・復号
   - デジタル署名の生成と検証
   - キーラッピング（鍵の暗号化）
   - メッセージ認証

5. **セキュリティ基準への準拠**
   - FIPS 140-2
   - Common Criteria EAL 4+
   - PCI DSS
   - HIPAA

## キーのローテーション

1. **自動ローテーション**

   - カスタマーマスターキー（CMK）の年次自動ローテーション
   - 古いキーマテリアルは保持され、暗号化されたデータの復号に使用可能
   - 新しいキーマテリアルが暗号化操作に使用される
   - 設定方法
     - AWS マネジメントコンソール
     - AWS CLI
     - AWS SDK

2. **手動ローテーション**

   - 任意のタイミングでの新しい CMK の作成
   - エイリアスの更新による新しいキーへの切り替え
   - ユースケース
     - 緊急時のキー変更
     - 規制要件への対応
     - セキュリティポリシーの遵守

3. **ローテーションのベストプラクティス**

   - 定期的なローテーションスケジュールの設定
   - キーの使用状況の監視
   - 古いキーの廃止計画の策定
   - アプリケーションの影響評価

4. **インポートキーマテリアルのローテーション**

   - 外部からインポートしたキーマテリアルの手動ローテーション
   - 新しいインポートトークンの取得
   - キーマテリアルの再インポート
   - 有効期限の設定と管理

5. **監視とログ記録**
   - CloudTrail によるキーローテーションの記録
   - アラートの設定
   - コンプライアンスレポートの作成
   - 監査証跡の維持

## キーのライフサイクル

![KMS キーのライフサイクル](/image/security-identity&compliance/encryption/kms-key-lifecycle.svg)

1. **キーの状態**

   - 作成中（Creating）

     - キーマテリアルの生成中
     - インポート待ち

   - 有効（Enabled）

     - 暗号化操作が可能
     - キーポリシーが適用可能
     - 監査ログが記録される

   - 無効（Disabled）

     - 暗号化操作が不可
     - キーは保持されている
     - 再度有効化が可能

   - 保留中の削除（Pending Deletion）

     - 7-30 日の待機期間
     - 削除のキャンセルが可能
     - 暗号化操作は不可

   - 削除済み（Deleted）
     - キーマテリアルは完全に削除
     - 復元は不可能
     - メタデータは監査目的で保持

2. **状態遷移の特徴**

   - 論理的な無効化

     - 一時的な使用停止
     - いつでも再有効化可能
     - キーマテリアルは保持

   - 物理的な削除
     - 完全な削除
     - 復元不可能
     - 待機期間あり

3. **ライフサイクル管理のベストプラクティス**

   - 定期的なキーの棚卸し
   - 不要なキーの特定と削除
   - 削除前のバックアップ確認
   - アプリケーションへの影響評価

4. **監視とアラート**

   - キー状態の変更通知
   - 削除スケジュールの管理
   - 使用状況の追跡
   - コンプライアンスレポートの作成
