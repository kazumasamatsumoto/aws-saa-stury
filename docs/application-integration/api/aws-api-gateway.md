# Amazon API Gateway

## 目的
Amazon API Gatewayは、開発者がAPIを簡単に作成、公開、管理、モニタリング、保護できるようにするフルマネージドサービスです。

APIゲートウェイの主な目的は：
- バックエンドサービス（AWS Lambda、EC2、その他のAWSサービス）へのシームレスなアクセスを提供
- アプリケーションのフロントエンドとバックエンドを安全に接続
- トラフィックの管理と監視
- APIの保護とアクセス制御

## 機能

### 1. API管理
- RESTful APIとWebSocket APIの作成と管理
- APIのバージョン管理
- 複数の環境（開発、テスト、本番）のサポート
- カスタムドメイン名の設定

### 2. セキュリティ
- AWS IAMとの統合による認証・認可
- API キーによるアクセス制御
- AWS WAFとの統合によるセキュリティ強化
- SSL/TLS証明書の管理

### 3. パフォーマンス
- グローバルな配信とキャッシング
- スロットリング（レート制限）
- バーストハンドリング
- 自動スケーリング

### Exponential Backoff
API Gatewayでは、エラー発生時の再試行戦略としてExponential Backoff（指数関数的バックオフ）を実装しています：

#### 基本的な仕組み
- **再試行間隔**：
  - 1回目：1秒
  - 2回目：2秒
  - 3回目：4秒
  - 4回目：8秒
  - 以降、同様に倍増

#### 実装の詳細
1. **再試行条件**：
   - 5xx系エラー
   - スロットリングエラー（429 Too Many Requests）
   - ネットワーク接続エラー

2. **ジッター**：
   - ランダムな遅延を追加
   - 同時再試行の集中を防止
   - 0〜100ミリ秒のランダム値

3. **最大再試行回数**：
   - デフォルト：10回
   - カスタム設定可能

#### ベストプラクティス
1. **クライアント側の実装**：
   - SDKでの自動再試行の活用
   - カスタム再試行ロジックの実装

2. **タイムアウト設定**：
   - 適切なタイムアウト値の設定
   - 総再試行時間の考慮

3. **モニタリング**：
   - 再試行回数の監視
   - エラーパターンの分析
   - CloudWatchメトリクスの活用

#### 利点
- **システムの回復力向上**：
  - 一時的な障害からの自動回復
  - サービスの可用性向上

- **負荷の分散**：
  - ピーク時の負荷軽減
  - システムの安定性向上

- **運用コストの削減**：
  - 手動介入の必要性低減
  - 障害対応時間の短縮

### キャッシング
API Gatewayのキャッシングは、APIのパフォーマンスを向上させ、バックエンドへの負荷を軽減する重要な機能です：

#### キャッシングの仕組み
- **TTL（Time to Live）**：
  - キャッシュの有効期間を設定可能（0〜3600秒）
  - デフォルトは300秒

#### キャッシュ設定
- **キャッシュ容量**：
  - 0.5GB から 237GB まで選択可能
  - 価格は容量に応じて変動

#### キャッシュキーの設定
- **パラメータベース**：
  - クエリ文字列
  - ヘッダー
  - URLパス
  - リクエストボディ

#### キャッシュの無効化
- **手動無効化**：
  - 特定のキーのキャッシュを削除
  - キャッシュ全体をフラッシュ
- **自動無効化**：
  - TTLの期限切れ
  - キャッシュ容量の超過

### エンコーディング
API Gatewayは、様々なエンコーディング方式をサポートしてデータの効率的な転送を実現します：

#### コンテンツエンコーディング
1. **圧縮方式**：
   - GZIP
   - DEFLATE
   - IDENTITY（無圧縮）

2. **設定オプション**：
   - **最小圧縮サイズ**：
     - デフォルト：10KB
     - カスタム設定可能
   - **圧縮対象**：
     - テキストベースのコンテンツタイプ
     - カスタムコンテンツタイプの追加可能

#### 文字エンコーディング
- **サポート形式**：
  - UTF-8
  - ISO-8859-1
  - その他のエンコーディング

#### バイナリメディアタイプ
- **対応形式**：
  - イメージ（JPEG、PNG等）
  - PDF
  - 音声/動画ファイル
- **設定方法**：
  - バイナリメディアタイプの追加
  - Content-Type ヘッダーでの指定

### 4. モニタリングと分析
- CloudWatchとの統合による詳細なメトリクス
- APIコール、レイテンシー、エラーの監視
- カスタムログの設定
- 使用量の追跡

## API Gatewayのタイプ比較

| 機能 | HTTP API | WebSocket API | REST API | REST API (プライベート) |
|------|-----------|--------------|-----------|----------------------|
| **ユースケース** | シンプルなAPI、サーバーレス | リアルタイム双方向通信 | フル機能API | VPC内限定のAPI |
| **レイテンシー** | 最も低い | 低い | 中程度 | 中程度 |
| **コスト** | 最も低い | 中程度 | 高い | 高い |
| **統合タイプ** | HTTP、Lambda | Lambda、HTTP、AWS サービス | Lambda、HTTP、AWS サービス、モック | Lambda、HTTP、AWS サービス、モック |
| **認証** | IAM、JWT、Lambda | IAM、カスタム | IAM、Lambda、OAuth、API キー | IAM |
| **API管理** | 基本的 | 基本的 | 高度 | 高度 |
| **モニタリング** | CloudWatch | CloudWatch | CloudWatch、X-Ray | CloudWatch、X-Ray |
| **キャッシュ** | なし | なし | あり | あり |
| **スロットリング** | アカウントレベル | カスタマイズ可能 | カスタマイズ可能 | カスタマイズ可能 |
| **CORS** | あり | 適用外 | あり | あり |
| **エンドポイント** | リージョン、エッジ最適化 | リージョン | リージョン、エッジ最適化、プライベート | プライベート |

## HTTP APIとREST APIの違い

### HTTP API
- **シンプルで軽量**：基本的なAPI機能に特化
- **低コスト**：REST APIと比べて最大70%のコスト削減
- **レイテンシー**：REST APIより最大60%低い
- **主な用途**：
  - プロキシ統合のみが必要な場合
  - サーバーレスワークロード
  - シンプルなCRUD API

### REST API
- **高機能**：より多くの機能とカスタマイズオプションを提供
- **APIマネジメント機能**：
  - APIキー管理
  - リクエスト/レスポンスの変換
  - リクエストの検証
  - レスポンスのキャッシュ
- **主な用途**：
  - 複雑なAPI管理が必要な場合
  - APIキーによる認証が必要な場合
  - カスタムの認可が必要な場合

### 選択のガイドライン
1. **HTTP APIを選ぶ場合**：
   - コスト最適化が重要
   - 基本的なAPI機能のみが必要
   - Lambda、HTTP エンドポイントとの統合のみ

2. **REST APIを選ぶ場合**：
   - APIキーによる認証が必要
   - カスタムの認可が必要
   - レスポンスのキャッシュが必要
   - リクエスト/レスポンスの変換が必要

## 一般向け解説

### APIゲートウェイとは？
レストランの受付係をイメージしてください。お客様（クライアント）が来店すると、受付係は：
1. お客様の予約を確認し（認証）
2. 適切な席に案内し（ルーティング）
3. 注文を厨房（バックエンド）に伝え
4. 混雑時は待ち時間を管理します（トラフィック制御）

API Gatewayも同じように、アプリケーションの「受付係」として機能します：

### 主なメリット
1. **セキュリティの向上**
   - 不正なアクセスからバックエンドを保護
   - アクセス制御を一元管理

2. **コスト削減**
   - 必要な時だけ自動でスケール
   - インフラ管理の手間を削減

3. **開発効率の向上**
   - APIの作成・管理が簡単
   - 既存のバックエンドサービスとの統合が容易

4. **パフォーマンスの最適化**
   - グローバルな配信
   - キャッシングによる応答時間の短縮

### 使用例
- モバイルアプリのバックエンド
- マイクロサービスアーキテクチャ
- サードパーティとのデータ連携
- IoTデバイスとの通信

API Gatewayを使用することで、開発者はビジネスロジックの開発に集中でき、セキュリティやスケーリングなどのインフラ管理の心配をする必要がありません。

## API（Application Programming Interface）とは

### 基本概念
APIは、異なるソフトウェアやシステム間でのコミュニケーションを可能にするインターフェースです：

#### 定義
- **アプリケーション**：ソフトウェアやシステム
- **プログラミング**：コードを通じた通信
- **インターフェース**：システム間の接点

#### 役割
1. **通信の標準化**：
   - 決められたルールに従った通信
   - データ形式の統一
   - エラー処理の標準化

2. **抽象化**：
   - 内部実装の隠蔽
   - 使いやすいインターフェースの提供
   - 複雑な処理の簡略化

### 実世界での例え
レストランでの注文を例に説明すると：
- **メニュー** = API仕様書
- **ウェイター** = APIエンドポイント
- **注文方法** = APIメソッド（GET、POST等）
- **料理** = レスポンスデータ

### APIの種類
1. **Web API**：
   - RESTful API
   - SOAP API
   - GraphQL

2. **システムAPI**：
   - オペレーティングシステムAPI
   - データベースAPI
   - ハードウェアAPI

3. **ライブラリAPI**：
   - プログラミング言語の標準ライブラリ
   - サードパーティライブラリ

### APIのメリット
1. **開発効率の向上**：
   - 既存機能の再利用
   - 開発時間の短縮
   - コードの標準化

2. **セキュリティの確保**：
   - アクセス制御
   - データの保護
   - 認証・認可の一元管理

3. **スケーラビリティ**：
   - システムの独立性確保
   - 柔軟な拡張性
   - 負荷分散の容易さ
