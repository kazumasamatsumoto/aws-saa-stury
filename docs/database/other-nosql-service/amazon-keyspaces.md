# Amazon Keyspaces (for Apache Cassandra)

## 概要

- Apache Cassandra と互換性のあるマネージドデータベースサービス
- サーバーレスで拡張性の高い NoSQL データベース
- Cassandra Query Language (CQL) をサポート
- 従量課金制で、容量のプロビジョニングが不要

## 主なユースケース

- IoT デバイスデータの収集と分析
- 時系列データの管理
- 大規模なユーザープロファイル管理
- 高速な書き込みが必要なアプリケーション

## 特徴

### スケーラビリティ

- オンデマンドでの自動スケーリング
- 数百万のリクエストに対応可能
- 数ペタバイトまでのデータ保存に対応

### 可用性と耐久性

- マルチ AZ での自動レプリケーション
- 99.99%の可用性 SLA
- データの自動修復機能

### セキュリティ機能

- AWS KMS による保存データの暗号化
- TLS 1.2 による転送時の暗号化
- IAM による認証と認可
- VPC エンドポイントのサポート

### 運用管理

- サーバーレスアーキテクチャ
- バックアップの自動化
- ポイントインタイム復元（PITR）
- CloudWatch との統合によるモニタリング

## データモデル

### Wide-column Store の特徴

- 行指向ではなく列指向のデータモデル
- 動的な列の追加が可能
- 各行で異なる列を持つことが可能
- 効率的なデータ圧縮と検索

#### Wide-column Store の利点

- スキーマの柔軟性

  - 新しい列の追加が容易
  - 行ごとに異なる列数が可能
  - スパースなデータ構造に最適

- 効率的なデータ格納
  - 類似データの列単位での圧縮
  - 必要な列のみの読み取りが可能
  - ディスク I/O の最適化

#### Wide-column Store の設計パターン

- 時系列データの格納

  - タイムスタンプをクラスタリングキーとして使用
  - 各時点のデータを列として格納

- 多次元データの格納
  - 複数の属性を列として効率的に格納
  - 必要な属性のみを選択的に取得

### キーの種類と役割

#### パーティションキー（Partition Key）

- データ分散の基準

  - ハッシュ関数によってパーティションを決定
  - 負荷分散の要となる要素
  - 効率的なデータ検索の基盤

- 複合パーティションキー
  - 複数のカラムの組み合わせ
  - より細かい粒度でのデータ分散
  - 例：`PRIMARY KEY ((region, user_id))`

#### クラスタリングキー（Clustering Key）

- データの順序付け

  - パーティション内でのソート順を決定
  - 範囲クエリの効率化
  - 複数キーの指定が可能

- クラスタリング順序
  - ASC/DESC の指定が可能
  - 複数キーの順序組み合わせ
  - 例：`PRIMARY KEY (user_id, timestamp DESC)`

#### 複合キーの設計パターン

- 時系列データパターン

```sql
CREATE TABLE events (
    device_id text,
    event_time timestamp,
    event_type text,
    event_data map<text, text>,
    PRIMARY KEY ((device_id), event_time)
) WITH CLUSTERING ORDER BY (event_time DESC);
```

- 階層データパターン

```sql
CREATE TABLE user_activity (
    organization_id text,
    department_id text,
    user_id text,
    activity_time timestamp,
    activity_type text,
    PRIMARY KEY ((organization_id, department_id), user_id, activity_time)
) WITH CLUSTERING ORDER BY (user_id ASC, activity_time DESC);
```

### キー設計のベストプラクティス

- パーティションキーの選択

  - データの均一な分散
  - ホットスポットの回避
  - クエリパターンとの整合性

- クラスタリングキーの選択

  - 頻繁な範囲クエリの対象
  - データの論理的なグループ化
  - 効率的なデータ取得

- アンチパターンの回避
  - 過度に大きなパーティション
  - 不均一なデータ分散
  - 非効率なクエリパターン

### データ構造の階層

- キースペース（Keyspace）

  - データベースに相当
  - 複数のテーブルをグループ化
  - レプリケーション戦略を定義

- テーブル（Table）

  - 行と列で構成される
  - パーティションキーによってデータが分散配置
  - スキーマ定義が必要

- 行（Row）
  - 一意のプライマリキーで識別
  - 複数の列を持つ
  - スパース（疎）なデータ構造をサポート

### プライマリキーの構成

- パーティションキー

  - データの分散配置を決定
  - 1 つまたは複数のカラムで構成可能
  - 効率的なデータ検索の基準

- クラスタリングキー（オプション）
  - パーティション内でのデータの並び順を決定
  - 複数のカラムを指定可能
  - 範囲クエリに利用

### データ型

#### 基本データ型

- text/varchar：文字列
- int/bigint：整数
- float/double：浮動小数点
- boolean：真偽値
- timestamp：日時
- uuid/timeuuid：一意識別子

#### コレクション型

- list：順序付きリスト
- set：重複のない集合
- map：キーと値のペア

### パーティショニングの考慮事項

- 適切なパーティションサイズ

  - 推奨：100MB 未満
  - 最大：1GB

- データアクセスパターン

  - 頻繁にアクセスされるデータは同じパーティションに
  - ホットパーティションの回避

- パーティションキーの選択基準
  - データの均一な分散
  - クエリパターンとの整合性
  - スケーラビリティの確保

### クエリ例

#### テーブル作成

```sql
CREATE TABLE IF NOT EXISTS store.shopping_cart (
    customerid text,
    cartid timeuuid,
    item text,
    price decimal,
    quantity int,
    PRIMARY KEY ((customerid), cartid)
);
```

#### データ挿入

```sql
INSERT INTO store.shopping_cart
(customerid, cartid, item, price, quantity)
VALUES
('C1', now(), 'Book', 29.99, 1);
```

#### データ検索

```sql
SELECT * FROM store.shopping_cart
WHERE customerid = 'C1'
AND cartid > minTimeuuid('2024-01-01 00:00:00');
```

## 制限事項

- Apache Cassandra の一部機能は利用不可
  - ライトウェイトトランザクション
  - ユーザー定義関数
  - マテリアライズドビュー
- 1 テーブルあたりの最大サイズ：3 TiB
- パーティションあたりの最大サイズ：1 GB

## 料金体系

- オンデマンドモード
  - 実際の使用量に基づく課金
  - 読み取り/書き込みリクエスト数
  - ストレージ使用量
- プロビジョンドモード
  - 事前に容量を確保
  - 予測可能なワークロード向け

## Amazon Keyspaces をわかりやすく解説

### Amazon Keyspaces とは？

Amazon Keyspaces は、大量のデータを効率的に保存・検索できるデータベースサービスです。以下のような特徴があります：

- サーバーの管理が不要（AWS が全て管理）
- 必要に応じて自動で拡張
- 使った分だけの料金支払い
- 高い信頼性と安全性

### どんな時に使うの？

以下のようなケースで特に役立ちます：

1. IoT センサーデータの収集

   - 例：工場の温度センサーの記録
   - 例：配送車両の位置情報の追跡

2. ユーザー活動の記録

   - 例：スマートフォンアプリの利用履歴
   - 例：EC サイトでの購買履歴

3. 大規模なログデータの保存
   - 例：システムの動作ログ
   - 例：セキュリティイベントの記録

### 従来のデータベースとの違い

#### 一般的なデータベース（RDB）の場合

- 決まった形式でデータを保存
- テーブル同士の関連付けが得意
- 大量データの処理は苦手

#### Amazon Keyspaces の場合

- 柔軟な形式でデータを保存可能
- 大量データの処理が得意
- シンプルな検索が高速

### データの保存方法

電話帳をイメージするとわかりやすいです：

1. パーティションキー

   - 例：電話帳の「あ行」「か行」のような区分け
   - データを探す時の最初の手がかり

2. クラスタリングキー
   - 例：各行の中での並び順
   - 時系列データなら日時順に並べる

### 具体的な使用例

#### EC サイトでの利用例

```sql
CREATE TABLE shopping_history (
    user_id text,           -- ユーザーID（パーティションキー）
    purchase_date timestamp,-- 購入日時（クラスタリングキー）
    product_name text,      -- 商品名
    price decimal,          -- 価格
    quantity int,          -- 数量
    PRIMARY KEY ((user_id), purchase_date)
);
```

#### IoT センサーでの利用例

```sql
CREATE TABLE sensor_data (
    sensor_id text,        -- センサーID（パーティションキー）
    reading_time timestamp,-- 計測時刻（クラスタリングキー）
    temperature float,     -- 温度
    humidity float,        -- 湿度
    PRIMARY KEY ((sensor_id), reading_time)
);
```

### 料金の考え方

シンプルな 3 つのポイント：

1. 保存量に応じた料金

   - データの量に比例
   - 長期保存も可能

2. リクエスト量に応じた料金

   - データの読み書きの回数で決まる
   - 使った分だけ支払い

3. 選べる料金プラン
   - 使った分だけ払うプラン
   - 事前に容量を確保するプラン

### 始める前に考えること

1. データの特徴を把握

   - どのくらいの量？
   - どんな検索が必要？

2. コストの見積もり

   - 予想されるデータ量は？
   - 1 日あたりの読み書き回数は？

3. セキュリティの要件
   - 誰がアクセスできる？
   - データの暗号化は必要？

## Cassandra アーキテクチャ

### リングトポロジの概要

Cassandra は分散システムとして、リング状のアーキテクチャを採用しています。Amazon Keyspaces はこのアーキテクチャを完全にマネージドなサービスとして提供します。

#### リングトポロジの特徴

- データの分散配置

  - ハッシュ値に基づくデータの分散
  - 複数ノードにまたがるデータの冗長化
  - 負荷の均一な分散

- スケーラビリティ
  - ノードの追加・削除が容易
  - データの自動再配置
  - 無停止でのスケーリング

#### トークンリング

- 各ノードが担当するトークン範囲を持つ
- パーティションキーのハッシュ値がトークンに変換
- トークンに基づいてデータの配置を決定

```ascii
    [Node 1]     [Node 2]
   /         \  /        \
  |           ||          |
  |  -2^63    ||   0     |
  |    to     ||   to    |
  |    0      ||  2^63   |
   \         /  \        /
    [Node 4]     [Node 3]
```

### わかりやすい解説：リングトポロジとは？

#### 郵便局での仕分けに例えると

リングトポロジは、複数の郵便局で配達地域を分担するようなシステムです：

1. データの分散

   - 各郵便局（ノード）が特定の地域（トークン範囲）を担当
   - 手紙（データ）は宛先（ハッシュ値）に基づいて適切な郵便局へ

2. 冗長性

   - 重要な手紙は複数の郵便局でコピーを保管
   - 一つの郵便局が停止しても他の郵便局がカバー

3. 拡張性
   - 新しい郵便局の追加が簡単
   - 担当地域（トークン範囲）を自動的に再調整

#### Amazon Keyspaces での実装

Amazon Keyspaces では、このような複雑な仕組みを全て自動で管理します：

- データの配置を自動で最適化
- 必要に応じてリソースを自動で追加
- バックアップと復旧を自動で実行

### リングトポロジと分散アルゴリズム

#### 一貫性ハッシュ法（Consistent Hashing）

リングトポロジは一貫性ハッシュ法を実装するための基盤となります：

- 目的

  - ノードの追加・削除時のデータ再配置を最小限に抑える
  - 負荷を均等に分散
  - スケーラビリティの確保

- 仕組み
  - 2^63 から 2^63 までの範囲をリング状に配置
  - データとノードを同じハッシュ空間にマッピング
  - データは時計回りに最も近いノードに割り当て

#### データの分散と複製

- プライマリコピー

  - パーティションキーのハッシュ値に基づいて配置
  - 担当ノードが書き込みを処理

- レプリカコピー
  - リング上で時計回りに次の N 個のノードに複製
  - 読み取りの負荷分散
  - 障害時の可用性確保

```ascii
    [Node 1] -----> [Node 2]
        ^              |
        |              |
        |              v
    [Node 4] <----- [Node 3]

    → データの複製の流れ
```

#### スケーリングの仕組み

1. ノード追加時
   - 新ノードがリングの一部の範囲を担当
   - 影響を受けるのは隣接ノードのみ
   - データの再配置は部分的

```ascii
Before:
    [Node 1] --- [Node 2]
        |           |
    [Node 4] --- [Node 3]

After:
    [Node 1] --- [Node 2]
        |    \     |
        |     [New Node]
        |           |
    [Node 4] --- [Node 3]
```

2. ノード削除時
   - 担当範囲を隣接ノードが引き継ぎ
   - トークン範囲の自動再調整
   - レプリカの再配置

#### 高可用性の実現方法

1. データの冗長化

   - レプリケーション係数（RF）の設定
   - 複数の AZ にまたがる複製
   - 同期/非同期レプリケーション

2. 障害検知と復旧

   - ゴシッププロトコルによるノード状態の監視
   - 自動的なフェイルオーバー
   - ヒンティッドハンドオフによる一時的障害対応

3. 整合性の保証
   - クォーラムベースの読み書き
   - 整合性レベルの調整
   - 最終的整合性の実現

#### Amazon Keyspaces での最適化

Amazon Keyspaces では、このような複雑な分散システムの管理を自動化しています：

- 自動スケーリング

  - トラフィックに応じた容量調整
  - バックグラウンドでのデータ再配置
  - パフォーマンスの最適化

- 運用の簡素化

  - ノード管理が不要
  - 自動的なバックアップ
  - モニタリングとアラート

- 信頼性の向上
  - マルチ AZ 構成
  - 自動フェイルオーバー
  - 99.99%の可用性 SLA
